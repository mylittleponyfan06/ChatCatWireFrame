<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatCat ¬∑ Contextual Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" aria-label="Primary navigation">
      <div class="brand">
        <div class="logo">üê±</div>
        <div>
          <p class="brand__name">ChatCat</p>
          <p class="brand__meta">Whatsapp classifier</p>
        </div>
        <button class="sidebar__toggle" id="sidebarToggle" aria-label="Collapse sidebar">‚óÄ</button>
      </div>
      <nav class="nav">
        <button class="nav__item" data-page="dashboard" onclick="location.href='../index.html'">Dashboard</button>
        <button class="nav__item" data-page="workspaces" onclick="location.href='workspaces.html'">Workspaces</button>
        <button class="nav__item active" data-page="search" onclick="location.href='contextual-search.html'">Contextual Search</button>
        <button class="nav__item" data-page="summarize" onclick="location.href='summarize.html'">Summarize</button>
        <button class="nav__item" data-page="upload" onclick="location.href='upload.html'">Upload</button>
        <button class="nav__item" data-page="emotion" onclick="location.href='emotion-scan.html'">Emotion Scan</button>
      </nav>
      <div class="sidebar__footer">
        <label class="toggle">
          <input type="checkbox" id="seniorToggle" />
          <span>Senior-friendly UI</span>
        </label>
        <div class="user">
          <div class="avatar">CC</div>
          <div>
            <p class="user__name">Demo User</p>
            <p class="user__meta">demo@chatcat.com</p>
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="page active" id="page-search" data-page="search">
        <header class="topbar">
          <h2>Contextual Search</h2>
        </header>

        <section class="panel">
          <div class="search-panel">
            <input type="text" placeholder="Try: 'math assignment'" id="searchInput" />
            <button class="primary" id="searchBtn">Search</button>
            <button class="ghost" id="advancedFiltersBtn">Advanced filters</button>
          </div>
        </section>
        <section class="panel" id="filtersPanel" style="display: none;">
          <div class="panel__header">
            <h3>Advanced Filters</h3>
            <button class="ghost" id="clearFiltersBtn">Clear all</button>
          </div>
          <div class="filters-grid">
            <div class="filter-group">
              <h4 class="filter-label">Tone</h4>
              <label class="filter-option">
                <input type="checkbox" name="tone" value="frustrated" class="tone-filter" />
                <span>üò† Frustrated</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="tone" value="excited" class="tone-filter" />
                <span>üéâ Excited/Celebratory</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="tone" value="neutral" class="tone-filter" />
                <span>üòê Neutral</span>
              </label>
            </div>
            <div class="filter-group">
              <h4 class="filter-label">Type</h4>
              <label class="filter-option">
                <input type="checkbox" name="type" value="messages" class="type-filter" />
                <span>üí¨ Messages</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="type" value="images" class="type-filter" />
                <span>üñºÔ∏è Images</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="type" value="documents" class="type-filter" />
                <span>üìÑ Documents</span>
              </label>
              <label class="filter-option">
                <input type="checkbox" name="type" value="videos" class="type-filter" />
                <span>üé• Videos</span>
              </label>
            </div>
            <div class="filter-group">
              <h4 class="filter-label">Date Range</h4>
              <div class="date-inputs">
                <input type="date" id="dateFrom" placeholder="From" />
                <input type="date" id="dateTo" placeholder="To" />
              </div>
            </div>
          </div>
        </section>
        <section class="panel">
          <div class="panel__header">
            <h3>Recent searches</h3>
          </div>
          <div class="history-grid" id="historyGrid"></div>
        </section>

        <section class="panel" id="resultsPanel" style="display: none;">
          <div class="panel__header">
            <h3>Results (<span id="resultCount">0</span>)</h3>
            <div class="results-actions">
              <button class="ghost" id="selectAllBtn" style="display: none;">Select all</button>
              <button class="ghost" id="viewDetailsBtn" style="display: none;">View details</button>
              <button class="primary" id="addToWorkspaceBtn" style="display: none;">Add to workspace</button>
              <button class="ghost" id="tagForReviewBtn" style="display: none;">Tag items</button>
            </div>
          </div>
          <div id="resultsList"></div>
        </section>

        <section class="panel" id="detailPanel" style="display: none;">
          <div class="panel__header">
            <button class="ghost" id="backBtn">‚Üê Back</button>
            <h3 id="detailTitle"></h3>
          </div>
          <div id="detailContent"></div>
        </section>

        <!-- Tag Menu -->
        <div class="tag-menu" id="tagMenu" style="display: none;">
          <div class="tag-menu-content">
            <p style="margin: 0 0 12px 0; font-weight: 600;">Tag selected items:</p>
            <button class="tag-option" data-tag="interesting">‚≠ê Interesting</button>
            <button class="tag-option" data-tag="follow-up">üîî Follow-up</button>
            <button class="tag-option" data-tag="archive">üì¶ Archive</button>
            <button class="tag-option" data-tag="important">‚ö†Ô∏è Important</button>
            <button class="ghost" style="width: 100%; margin-top: 8px;" id="closeTagMenuBtn">Cancel</button>
          </div>
        </div>

        <!-- Action Confirmation Display -->
        <div class="action-confirmation" id="actionConfirmation" style="display: none;">
          <div class="confirmation-content">
            <div class="confirmation-header">
              <span class="confirmation-icon" id="confirmationIcon">‚úì</span>
              <h4 id="confirmationTitle">Items tagged</h4>
            </div>
            <div class="confirmation-body">
              <p id="confirmationMessage">2 items tagged as Interesting</p>
              <div class="confirmation-details">
                <div class="detail-row">
                  <span class="detail-label">Type:</span>
                  <span class="detail-value" id="detailType">Tag</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Category:</span>
                  <span class="detail-value" id="detailCategory">Interesting</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Count:</span>
                  <span class="detail-value" id="detailCount">2 items</span>
                </div>
              </div>
            </div>
            <button class="ghost" style="width: 100%; margin-top: 12px;" id="closeConfirmationBtn">Done</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="toast-container" id="toastContainer"></div>
  <script src="../script-shared.js"></script>
  <script src="../pages-shared.js"></script>
  <script>
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const historyGrid = document.getElementById('historyGrid');
    const resultsList = document.getElementById('resultsList');
    const resultsPanel = document.getElementById('resultsPanel');
    const detailPanel = document.getElementById('detailPanel');
    const resultCount = document.getElementById('resultCount');
    const backBtn = document.getElementById('backBtn');
    const detailTitle = document.getElementById('detailTitle');
    const detailContent = document.getElementById('detailContent');
    const tagMenu = document.getElementById('tagMenu');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const viewDetailsBtn = document.getElementById('viewDetailsBtn');
    const addToWorkspaceBtn = document.getElementById('addToWorkspaceBtn');
    const tagForReviewBtn = document.getElementById('tagForReviewBtn');
    const closeTagMenuBtn = document.getElementById('closeTagMenuBtn');
    const actionConfirmation = document.getElementById('actionConfirmation');
    const closeConfirmationBtn = document.getElementById('closeConfirmationBtn');

    let selectedItems = new Set();
    let currentResults = [];

    const tagNames = {
      'interesting': '‚≠ê Interesting',
      'follow-up': 'üîî Follow-up',
      'archive': 'üì¶ Archive',
      'important': '‚ö†Ô∏è Important'
    };

    const samples = {
      'soccer practice photos': {
        title: 'Find: soccer practice photos',
        meta: '5 items - attachments',
        items: [
          { name: 'soccer-practice-01.jpg', size: '2.4 MB', date: '12 Jul 3:45 PM', sender: 'Kai' },
          { name: 'soccer-practice-02.jpg', size: '3.1 MB', date: '12 Jul 3:46 PM', sender: 'Kai' },
          { name: 'soccer-practice-03.jpg', size: '2.8 MB', date: '12 Jul 3:47 PM', sender: 'Kai' },
          { name: 'soccer-goal-highlight.mp4', size: '8.5 MB', date: '12 Jul 4:00 PM', sender: 'Mom' },
          { name: 'team-photo.jpg', size: '4.2 MB', date: '12 Jul 4:15 PM', sender: 'Coach' }
        ]
      },
      'math assignment': {
        title: 'Find: math assignment',
        meta: '4 items - documents',
        items: [
          { name: 'algebra-assignment.pdf', size: '0.9 MB', date: '15 Jan 1:00 PM', sender: 'Jasmine' },
          { name: 'math-homework-help.docx', size: '0.5 MB', date: '15 Jan 2:30 PM', sender: 'Kai' },
          { name: 'calculus-notes.pdf', size: '1.2 MB', date: '16 Jan 10:15 AM', sender: 'You' },
          { name: 'solution-guide.xlsx', size: '0.8 MB', date: '16 Jan 11:45 AM', sender: 'Teacher' }
        ]
      },
      'frustrated messages': {
        title: 'Tone: frustrated messages',
        meta: '2 items - emotional tone',
        items: [
          { sender: 'Kai', text: 'I cannot believe the project deadline moved again. This is the third time!', time: '09 Jan 2:15 PM' },
          { sender: 'Kai', text: 'How am I supposed to deliver quality work with these constant changes?', time: '09 Jan 2:16 PM' }
        ]
      },
      'invoices and receipts': {
        title: 'Find: invoices and receipts',
        meta: '6 items - financial documents',
        items: [
          { name: 'Q3-Invoice-2025.pdf', size: '1.2 MB', date: '30 Oct 9:00 AM', sender: 'Finance' },
          { name: 'Invoice-Aug-2025.xlsx', size: '0.8 MB', date: '31 Aug 10:30 AM', sender: 'Accounting' },
          { name: 'Invoice-Sep-2025.xlsx', size: '0.9 MB', date: '30 Sep 2:00 PM', sender: 'Accounting' },
          { name: 'Invoice-Oct-2025.xlsx', size: '0.85 MB', date: '31 Oct 3:15 PM', sender: 'Accounting' },
          { name: 'Receipt-Q3-summary.pdf', size: '0.6 MB', date: '02 Nov 11:00 AM', sender: 'CFO' },
          { name: 'Expense-report-Q3.docx', size: '0.7 MB', date: '01 Nov 9:30 AM', sender: 'You' }
        ]
      },
      'deadline mentions': {
        title: 'Search: deadline mentions',
        meta: '8 items - mixed results',
        items: [
          { sender: 'Jasmine', text: 'Math assignment due Friday', time: '15 Jan 1:20 PM' },
          { sender: 'Mom', text: 'Project deadline is next Tuesday', time: '16 Jan 10:00 AM' },
          { name: 'deadline-checklist.pdf', size: '0.5 MB', date: '15 Jan 4:05 PM' },
          { sender: 'Coach', text: 'Registration deadline extended to Sunday', time: '14 Jan 6:15 PM' },
          { name: 'project-timeline.docx', size: '1.1 MB', date: '15 Jan 5:20 PM' },
          { sender: 'You', text: 'Reminder: submission deadline tomorrow', time: '16 Jan 3:00 PM' },
          { sender: 'Teacher', text: 'Grades due by end of month', time: '16 Jan 2:45 PM' }
        ]
      },
      'mentions of assignment': {
        title: 'Search: mentions of assignment',
        meta: '12 items - multiple subjects',
        items: [
          { sender: 'Jasmine', text: 'Math assignment due Friday', time: '15 Jan 1:20 PM' },
          { sender: 'Kai', text: 'Can you review my chemistry assignment?', time: '15 Jan 3:45 PM' },
          { sender: 'You', text: 'English assignment is 5 pages', time: '14 Jan 8:00 PM' },
          { name: 'math-assignment-draft.pdf', size: '0.5 MB', date: '15 Jan 4:05 PM' },
          { sender: 'Teacher', text: 'Great work on the last assignment!', time: '13 Jan 2:30 PM' },
          { name: 'chem-lab-assignment.docx', size: '1.1 MB', date: '15 Jan 5:20 PM' },
          { sender: 'Kai', text: 'Is the assignment due tonight?', time: '15 Jan 7:15 PM' },
          { name: 'essay-assignment.txt', size: '0.2 MB', date: '14 Jan 8:30 PM' },
          { sender: 'Jasmine', text: 'I finished my assignment early', time: '14 Jan 9:45 PM' },
          { sender: 'Mom', text: 'How is that assignment coming along?', time: '15 Jan 6:00 PM' },
          { name: 'assignment-rubric.pdf', size: '0.7 MB', date: '13 Jan 10:00 AM' },
          { sender: 'Coach', text: 'Assignment for next practice: run drills', time: '12 Jan 4:30 PM' }
        ]
      },
      'celebratory messages': {
        title: 'Tone: celebratory messages',
        meta: '3 items - positive emotions',
        items: [
          { sender: 'Mom', text: 'We got the house! üéâ', time: '22 Jan 5:45 PM' },
          { sender: 'Jasmine', text: 'YES! We WON the match!', time: '18 Jan 7:30 PM' },
          { sender: 'Coach', text: 'Great work everyone! So proud of you all!', time: '18 Jan 7:35 PM' }
        ]
      },
      'birthday planning': {
        title: 'Search: birthday planning',
        meta: '12 items - event planning',
        items: [
          { sender: 'Mom', text: 'We should plan something special for your birthday', time: '20 Jan 5:15 PM' },
          { sender: 'Jasmine', text: 'Birthday party next weekend?', time: '20 Jan 6:30 PM' },
          { sender: 'You', text: 'I like cake and games', time: '20 Jan 7:00 PM' },
          { name: 'party-ideas.pdf', size: '0.8 MB', date: '20 Jan 5:45 PM' },
          { sender: 'Kai', text: 'Birthday decorations - colors?', time: '21 Jan 10:00 AM' },
          { name: 'decoration-photos.zip', size: '3.2 MB', date: '21 Jan 10:30 AM' },
          { sender: 'Mom', text: 'Birthday cake ordered', time: '21 Jan 2:30 PM' },
          { sender: 'Coach', text: 'Can you come to birthday celebration?', time: '19 Jan 4:15 PM' },
          { name: 'guest-list.xlsx', size: '0.4 MB', date: '20 Jan 8:00 PM' },
          { sender: 'You', text: 'Birthday is Jan 25th!', time: '18 Jan 11:30 AM' },
          { sender: 'Jasmine', text: 'Cant wait for your birthday!', time: '20 Jan 9:00 PM' },
          { name: 'birthday-invites.pdf', size: '1.1 MB', date: '20 Jan 7:45 PM' }
        ]
      }
    };

    function updateActionButtons() {
      const hasSelection = selectedItems.size > 0;
      selectAllBtn.style.display = currentResults.length > 0 ? 'block' : 'none';
      viewDetailsBtn.style.display = hasSelection ? 'block' : 'none';
      addToWorkspaceBtn.style.display = hasSelection ? 'block' : 'none';
      tagForReviewBtn.style.display = hasSelection ? 'block' : 'none';
    }

    function doSearch() {
      const query = searchInput.value.trim();
      if (!query) {
        alert('Enter a search query');
        return;
      }

      let result;
      if (samples[query]) {
        result = samples[query];
      } else {
        // For custom searches, search across all sample data
        let allItems = [];
        for (const key in samples) {
          allItems = allItems.concat(samples[key].items);
        }
        
        // Check if searching by sender (e.g., "from kai")
        const fromMatch = query.toLowerCase().match(/from\s+(\w+)/);
        const senderFilter = fromMatch ? fromMatch[1].toLowerCase() : null;
        
        if (senderFilter) {
          allItems = allItems.filter(function(item) {
            return item.sender && item.sender.toLowerCase().includes(senderFilter);
          });
        }
        
        result = { 
          title: 'Search: ' + query, 
          meta: 'Custom search', 
          items: allItems.length > 0 ? allItems : [{ sender: 'System', text: 'Searching for: ' + query }]
        };
      }

      // Apply filters
      let filteredItems = result.items;
      
      // Tone filters
      const selectedTones = Array.from(document.querySelectorAll('.tone-filter:checked')).map(function(cb) { return cb.value; });
      if (selectedTones.length > 0) {
        filteredItems = filteredItems.filter(function(item) {
          if (selectedTones.includes('frustrated') && item.sender === 'Kai' && item.text && item.text.toLowerCase().includes('cannot')) return true;
          if (selectedTones.includes('excited') && item.text && (item.text.includes('!') || item.text.includes('üéâ'))) return true;
          if (selectedTones.includes('neutral') && item.sender && !item.text.includes('!')) return true;
          return false;
        });
      }
      
      // Type filters
      const selectedTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(function(cb) { return cb.value; });
      if (selectedTypes.length > 0) {
        filteredItems = filteredItems.filter(function(item) {
          if (selectedTypes.includes('messages') && item.sender && item.text) return true;
          if (selectedTypes.includes('images') && item.name && (item.name.endsWith('.jpg') || item.name.endsWith('.png'))) return true;
          if (selectedTypes.includes('documents') && item.name && (item.name.endsWith('.pdf') || item.name.endsWith('.docx') || item.name.endsWith('.xlsx'))) return true;
          if (selectedTypes.includes('videos') && item.name && item.name.endsWith('.mp4')) return true;
          return false;
        });
      }

      currentResults = filteredItems;
      selectedItems.clear();
      resultCount.textContent = filteredItems.length;
      resultsList.innerHTML = '';
      
      filteredItems.forEach(function(item, idx) {
        const div = document.createElement('div');
        div.className = 'card';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'card-checkbox';
        checkbox.addEventListener('change', function(e) {
          e.stopPropagation();
          if (checkbox.checked) {
            selectedItems.add(idx);
          } else {
            selectedItems.delete(idx);
          }
          updateActionButtons();
        });
        
        const label = document.createElement('div');
        label.style.flex = '1';
        let labelText = item.name || (item.text ? (item.sender ? item.sender + ': ' + item.text : item.text) : 'Item');
        label.textContent = labelText;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        div.addEventListener('click', function(e) {
          checkbox.checked = !checkbox.checked;
          if (checkbox.checked) {
            selectedItems.add(idx);
          } else {
            selectedItems.delete(idx);
          }
          updateActionButtons();
        });
        resultsList.appendChild(div);
      });

      resultsPanel.style.display = 'block';
      detailPanel.style.display = 'none';
      updateActionButtons();
    }

    function showSelectedDetails() {
      if (selectedItems.size === 0) return;
      
      const selectedIndices = Array.from(selectedItems);
      const selectedResults = selectedIndices.map(function(idx) { return currentResults[idx]; });
      
      detailTitle.textContent = 'Selected Items (' + selectedItems.size + ')';
      detailContent.innerHTML = selectedResults.map(function(item) {
        if (item.sender) return '<div style="padding: 12px; border-bottom: 1px solid var(--border);"><strong>' + item.sender + ':</strong> ' + item.text + ' <span style="color: #8d92a3; font-size: 12px;">' + item.time + '</span></div>';
        return '<div style="padding: 12px; border-bottom: 1px solid var(--border);"><strong>[' + item.name.split('.').pop().toUpperCase() + ']</strong> ' + item.name + ' <span style="color: #8d92a3;">(' + item.size + ')</span> - ' + item.date + '</div>';
      }).join('');
      resultsPanel.style.display = 'none';
      detailPanel.style.display = 'block';
    }

    function showTagMenu() {
      if (selectedItems.size === 0) {
        alert('Select items first');
        return;
      }
      tagMenu.style.display = 'block';
    }

    function closeTagMenu() {
      tagMenu.style.display = 'none';
    }

    function tagItems(tagName) {
      const count = selectedItems.size;
      const tagDisplayName = tagNames[tagName] || tagName;
      
      document.getElementById('confirmationIcon').textContent = 'üè∑Ô∏è';
      document.getElementById('confirmationTitle').textContent = 'Items Tagged';
      document.getElementById('confirmationMessage').textContent = count + ' item(s) tagged as ' + tagDisplayName;
      document.getElementById('detailType').textContent = 'Tag';
      document.getElementById('detailCategory').textContent = tagDisplayName;
      document.getElementById('detailCount').textContent = count + ' item' + (count !== 1 ? 's' : '');
      
      actionConfirmation.style.display = 'block';
      tagMenu.style.display = 'none';
      selectedItems.clear();
      updateActionButtons();
    }

    function addToWorkspace() {
      if (selectedItems.size === 0) {
        alert('Select items first');
        return;
      }
      
      const count = selectedItems.size;
      document.getElementById('confirmationIcon').textContent = 'üì¶';
      document.getElementById('confirmationTitle').textContent = 'Added to Workspace';
      document.getElementById('confirmationMessage').textContent = count + ' item(s) added to workspace';
      document.getElementById('detailType').textContent = 'Workspace';
      document.getElementById('detailCategory').textContent = 'Default';
      document.getElementById('detailCount').textContent = count + ' item' + (count !== 1 ? 's' : '');
      
      actionConfirmation.style.display = 'block';
      selectedItems.clear();
      updateActionButtons();
    }

    // Event listeners
    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') doSearch();
    });
    backBtn.addEventListener('click', function() {
      detailPanel.style.display = 'none';
      resultsPanel.style.display = 'block';
    });
    const filtersPanel = document.getElementById('filtersPanel');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    let filtersVisible = false;

    document.getElementById('advancedFiltersBtn').addEventListener('click', function() {
      filtersVisible = !filtersVisible;
      filtersPanel.style.display = filtersVisible ? 'block' : 'none';
      this.textContent = filtersVisible ? 'Hide filters' : 'Advanced filters';
    });

    clearFiltersBtn.addEventListener('click', function() {
      document.querySelectorAll('.tone-filter, .type-filter').forEach(function(cb) {
        cb.checked = false;
      });
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
    });

    // Action buttons
    viewDetailsBtn.addEventListener('click', showSelectedDetails);
    tagForReviewBtn.addEventListener('click', showTagMenu);
    closeTagMenuBtn.addEventListener('click', closeTagMenu);
    closeConfirmationBtn.addEventListener('click', function() {
      actionConfirmation.style.display = 'none';
    });
    addToWorkspaceBtn.addEventListener('click', addToWorkspace);
    selectAllBtn.addEventListener('click', function() {
      if (selectedItems.size === currentResults.length) {
        selectedItems.clear();
      } else {
        selectedItems.clear();
        for (let i = 0; i < currentResults.length; i++) {
          selectedItems.add(i);
        }
      }
      updateActionButtons();
      document.querySelectorAll('.card-checkbox').forEach(function(cb, idx) {
        cb.checked = selectedItems.has(idx);
      });
    });

    // Tag options
    document.querySelectorAll('.tag-option').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const tag = this.getAttribute('data-tag');
        tagItems(tag);
      });
    });

    // Populate history
    const historyQueries = ['soccer practice photos', 'frustrated messages', 'invoices and receipts', 'birthday planning'];
    historyQueries.forEach(function(query) {
      const btn = document.createElement('button');
      btn.className = 'history-item';
      btn.textContent = query;
      btn.addEventListener('click', function() {
        searchInput.value = query;
        doSearch();
      });
      historyGrid.appendChild(btn);
    });
  </script>
</body>
</html>
